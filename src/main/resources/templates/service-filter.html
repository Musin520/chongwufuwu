<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务筛选 - 宠物服务平台</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- jQuery UI CSS (for slider) -->
    <link href="https://cdn.bootcdn.net/ajax/libs/jqueryui/1.13.2/themes/ui-lightness/jquery-ui.min.css" rel="stylesheet">
    
    <style>
        .filter-card {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .service-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 20px;
        }
        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .price-range-slider {
            margin: 20px 0;
        }
        .rating-stars {
            color: #ffc107;
        }
        .time-slot {
            display: inline-block;
            margin: 5px;
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-slot.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .time-slot:hover {
            border-color: #007bff;
        }
        .loading {
            text-align: center;
            padding: 50px;
        }
        .no-results {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .filter-section {
            margin-bottom: 25px;
        }
        .filter-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 筛选侧边栏 -->
            <div class="col-md-3">
                <div class="card filter-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-filter"></i> 筛选条件</h5>
                    </div>
                    <div class="card-body">
                        <!-- 时间段筛选 -->
                        <div class="filter-section">
                            <div class="filter-title">服务时间</div>
                            <div class="time-slots">
                                <div class="time-slot" data-start="08:00" data-end="12:00">上午 (8:00-12:00)</div>
                                <div class="time-slot" data-start="12:00" data-end="18:00">下午 (12:00-18:00)</div>
                                <div class="time-slot" data-start="18:00" data-end="22:00">晚上 (18:00-22:00)</div>
                                <div class="time-slot" data-start="08:00" data-end="22:00">全天 (8:00-22:00)</div>
                            </div>
                        </div>
                        
                        <!-- 价格区间筛选 -->
                        <div class="filter-section">
                            <div class="filter-title">价格区间</div>
                            <div class="price-range-slider">
                                <div id="price-slider"></div>
                                <div class="d-flex justify-content-between mt-2">
                                    <span>¥<span id="min-price-display">0</span></span>
                                    <span>¥<span id="max-price-display">1000</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 评分筛选 -->
                        <div class="filter-section">
                            <div class="filter-title">最低评分</div>
                            <div class="rating-filter">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rating" id="rating-all" value="" checked>
                                    <label class="form-check-label" for="rating-all">不限</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rating" id="rating-4" value="4">
                                    <label class="form-check-label" for="rating-4">
                                        <span class="rating-stars">★★★★☆</span> 4分以上
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rating" id="rating-4.5" value="4.5">
                                    <label class="form-check-label" for="rating-4.5">
                                        <span class="rating-stars">★★★★★</span> 4.5分以上
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 服务类型筛选 -->
                        <div class="filter-section">
                            <div class="filter-title">服务类型</div>
                            <select class="form-select" id="service-type">
                                <option value="">全部类型</option>
                                <!-- 动态加载服务类型 -->
                            </select>
                        </div>
                        
                        <!-- 关键词搜索 -->
                        <div class="filter-section">
                            <div class="filter-title">关键词搜索</div>
                            <input type="text" class="form-control" id="keyword" placeholder="输入服务名称关键词">
                        </div>
                        
                        <!-- 排序方式 -->
                        <div class="filter-section">
                            <div class="filter-title">排序方式</div>
                            <select class="form-select" id="sort-by">
                                <option value="">默认排序</option>
                                <option value="price_asc">价格从低到高</option>
                                <option value="price_desc">价格从高到低</option>
                                <option value="rating_desc">评分从高到低</option>
                            </select>
                        </div>
                        
                        <!-- 筛选按钮 -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="apply-filter">
                                <i class="fas fa-search"></i> 应用筛选
                            </button>
                            <button class="btn btn-outline-secondary" id="reset-filter">
                                <i class="fas fa-undo"></i> 重置筛选
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 结果展示区域 -->
            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>服务筛选结果</h4>
                    <div class="result-count">
                        共找到 <span id="total-count">0</span> 个服务
                    </div>
                </div>
                
                <!-- 加载状态 -->
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在搜索合适的服务...</p>
                </div>
                
                <!-- 结果列表 -->
                <div id="results-container">
                    <!-- 动态加载服务列表 -->
                </div>
                
                <!-- 无结果提示 -->
                <div id="no-results" class="no-results" style="display: none;">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>没有找到符合条件的服务</h5>
                    <p>请尝试调整筛选条件</p>
                </div>
                
                <!-- 分页 -->
                <nav aria-label="分页导航" id="pagination-container" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 动态生成分页 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <!-- jQuery UI -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // 初始化价格滑块
            $("#price-slider").slider({
                range: true,
                min: 0,
                max: 1000,
                values: [0, 1000],
                slide: function(event, ui) {
                    $("#min-price-display").text(ui.values[0]);
                    $("#max-price-display").text(ui.values[1]);
                }
            });
            
            // 时间段选择
            $('.time-slot').click(function() {
                $('.time-slot').removeClass('active');
                $(this).addClass('active');
            });
            
            // 加载服务类型
            loadServiceTypes();
            
            // 初始加载服务列表
            loadServices();
            
            // 应用筛选
            $('#apply-filter').click(function() {
                loadServices();
            });
            
            // 重置筛选
            $('#reset-filter').click(function() {
                resetFilters();
                loadServices();
            });
            
            // 关键词搜索回车事件
            $('#keyword').keypress(function(e) {
                if (e.which == 13) {
                    loadServices();
                }
            });
        });
        
        // 加载服务类型
        function loadServiceTypes() {
            $.get('/producttype', function(data) {
                if (data.code === 200 && data.list) {
                    const select = $('#service-type');
                    data.list.forEach(function(type) {
                        select.append(`<option value="${type.id}">${type.typeName}</option>`);
                    });
                }
            });
        }
        
        // 加载服务列表
        function loadServices(page = 1) {
            $('#loading').show();
            $('#results-container').empty();
            $('#no-results').hide();
            $('#pagination-container').hide();
            
            const filterData = getFilterData();
            filterData.pageNum = page;
            filterData.pageSize = 12;
            
            $.ajax({
                url: '/product/filterServices',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(filterData),
                success: function(response) {
                    $('#loading').hide();
                    if (response.code === 200 && response.data) {
                        displayResults(response.data);
                    } else {
                        showNoResults();
                    }
                },
                error: function() {
                    $('#loading').hide();
                    showNoResults();
                }
            });
        }
        
        // 获取筛选条件
        function getFilterData() {
            const activeTimeSlot = $('.time-slot.active');
            const priceRange = $("#price-slider").slider("values");
            
            return {
                serviceStartTime: activeTimeSlot.length ? activeTimeSlot.data('start') : null,
                serviceEndTime: activeTimeSlot.length ? activeTimeSlot.data('end') : null,
                minPrice: priceRange[0] > 0 ? priceRange[0] : null,
                maxPrice: priceRange[1] < 1000 ? priceRange[1] : null,
                minRating: $('input[name="rating"]:checked').val() || null,
                productType: $('#service-type').val() || null,
                keyword: $('#keyword').val().trim() || null,
                sortBy: $('#sort-by').val() || null
            };
        }
        
        // 显示结果
        function displayResults(data) {
            const container = $('#results-container');
            const services = data.list || [];
            
            $('#total-count').text(data.total || 0);
            
            if (services.length === 0) {
                showNoResults();
                return;
            }
            
            services.forEach(function(service) {
                const serviceCard = createServiceCard(service);
                container.append(serviceCard);
            });
            
            // 显示分页
            if (data.total > data.pageSize) {
                showPagination(data);
            }
        }
        
        // 创建服务卡片
        function createServiceCard(service) {
            const rating = service.companyRating || 0;
            const ratingStars = '★'.repeat(Math.floor(rating)) + '☆'.repeat(5 - Math.floor(rating));
            
            return `
                <div class="service-card p-3">
                    <div class="row">
                        <div class="col-md-3">
                            <img src="${service.img || '/static/img/noPhoto.png'}" 
                                 class="img-fluid rounded" alt="${service.productname}">
                        </div>
                        <div class="col-md-9">
                            <h5>${service.productname}</h5>
                            <p class="text-muted">${service.productdes || '暂无描述'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-primary h5">¥${service.kedanjia}</span>
                                    <small class="text-muted">/${service.fahuotianshu || '次'}</small>
                                </div>
                                <div>
                                    <span class="rating-stars">${ratingStars}</span>
                                    <small class="text-muted">(${service.companyRatingCount || 0}评价)</small>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> 
                                    ${service.serviceStartTime || '08:00'} - ${service.serviceEndTime || '18:00'}
                                </small>
                                <small class="text-muted ms-3">
                                    <i class="fas fa-store"></i> 
                                    ${service.companyName || '未知服务商'}
                                </small>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-primary btn-sm" onclick="viewService(${service.id})">
                                    查看详情
                                </button>
                                <button class="btn btn-outline-primary btn-sm ms-2" onclick="addToCart(${service.id})">
                                    加入购物车
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 显示无结果
        function showNoResults() {
            $('#no-results').show();
            $('#total-count').text(0);
        }
        
        // 重置筛选条件
        function resetFilters() {
            $('.time-slot').removeClass('active');
            $("#price-slider").slider("values", [0, 1000]);
            $("#min-price-display").text(0);
            $("#max-price-display").text(1000);
            $('input[name="rating"]').prop('checked', false);
            $('#rating-all').prop('checked', true);
            $('#service-type').val('');
            $('#keyword').val('');
            $('#sort-by').val('');
        }
        
        // 查看服务详情
        function viewService(serviceId) {
            window.open(`/web/usersingle?id=${serviceId}`, '_blank');
        }
        
        // 添加到购物车
        function addToCart(serviceId) {
            // 这里添加购物车逻辑
            alert('添加到购物车功能待实现');
        }
    </script>
</body>
</html>
