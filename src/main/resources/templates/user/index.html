<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">


    <title> 用户</title>
    <meta content="" name="keywords">
    <meta content="" name="description">

    <link href="favicon.ico" rel="shortcut icon">
    <script src="/static/DemoBootStrap/js/vue.js"></script>
    <!--    <link href="/static/hAdmin/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">-->
    <link href="/static/hAdmin/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <!-- Sweet Alert -->
    <link href="/static/hAdmin/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="/static/hAdmin/css/animate.css" rel="stylesheet">
    <link href="/static/hAdmin/css/style.css?v=4.1.0" rel="stylesheet">
    <link href="/static/hAdmin/css/plugins/toastr/toastr.min.css" rel="stylesheet">
    <link href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" rel="stylesheet">
    <style>
        .addList {
            padding: 10px 30px 10px 30px;
            height: 90px;
            margin-top: 3px
        }
    </style>

</head>

<body class="gray-bg animated bounceInDown">
<div id="app">
    <div id="block"
         style="width: 100%;height: 100%;background: #171717;opacity: 0.7;position: fixed;top: 0;left: 0;z-index: 999;text-align: center;display: none">
        <div style="margin-top: 300px">
            <span style="color: #ffffff;font-size: 20px;font-weight: 700">正在提交本次操作，请勿进行任何操作......</span>
        </div>
    </div>
    <div class="wrapper wrapper-content animated fadeInUp">
        <span id="gloUrl" style="display: none"></span>

        <div class="row">
            <div class="col-sm-12">

                <div class="ibox">
                    <div class="ibox-title" style="height: 55px;">
                        <h5>所有记录</h5>
                        <div class="ibox-tools">
                            <div class="text-center">
                                <el-button
                                        @click="handleAdd"
                                        v-if="role === '1'"
                                        type="primary">
                                    添加
                                </el-button>
                            </div>

                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="row m-b-sm m-t-sm">

                            <div class="col-md-11 form-inline">
                                <el-form :inline="true" :model="queryParams" class="demo-form-inline">
                                    <el-form-item label="用户姓名">
                                        <el-input placeholder="用户姓名" v-model="queryParams.username"></el-input>
                                    </el-form-item>
                                    <el-form-item label="角色">
                                        <el-select placeholder="角色" v-model="queryParams.role">
                                            <el-option label="用户" :value="2"></el-option>
                                            <el-option label="商家" :value="3"></el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button @click="getList" type="primary"><i class="fa fa-search"></i> 查询
                                        </el-button>
                                        <el-button @click="handleResetQuery" type="info"><i class="fa fa-circle"></i> 重置
                                        </el-button>
                                    </el-form-item>
                                </el-form>
                            </div>
                        </div>
                        <!--            列表          -->
                        <div class="project-list">
                            <div class="ibox-content">
                                <el-table
                                        :data="dataList"
                                        style="width: 100%"
                                        v-loading="loading">
                                    <el-table-column
                                            align="center"
                                            label="序号"
                                            prop="id"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="图片"
                                            prop="img"
                                    >
                                        <template slot-scope="scope">
                                            <el-image :src="scope.row.img"
                                                      style="width: 100px;height: 100px;"></el-image>
                                        </template>
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="用户姓名"
                                            prop="username"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="性别"
                                            prop="sex">
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="联系方式"
                                            prop="phonenumber">
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="年龄"
                                            prop="age">
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="账号"
                                            prop="account">
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="角色"
                                           >
                                        <template slot-scope="scope">
                                            <el-tag v-if="scope.row.role === '1'">管理员</el-tag>
                                            <el-tag type="success" v-if="scope.row.role === '2'">用户</el-tag>
                                            <el-tag type="danger" v-if="scope.row.role === '3'">商家</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="创建时间"
                                            prop="createtime">
                                    </el-table-column>

                                    <el-table-column
                                            align="center"
                                            label="操作"
                                            width="350px"
                                    >
                                        <template slot-scope="scope">
                                            <el-button @click="handleDetail(scope.row)" round
                                                       size="small" type="primary"
                                            ><i
                                                    class="fa fa-eye"></i> 查看
                                            </el-button>
                                            <el-button @click="handleEdit(scope.row)" round size="small" type="warning"
                                                       v-if="role === '1'">
                                                <i
                                                        class="fa fa-pencil"></i> 编辑
                                            </el-button>
                                            <el-button @click="handleDel(scope.row.id)" round size="small"

                                                       v-if="role === '1'&&  scope.row.id !== 1"
                                                       type="danger"><i
                                                    class="fa fa-trash"></i> 删除
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                        <div style="width: 100%;text-align: center">
                            <el-pagination
                                    :current-page.sync="queryParams.pageNum"
                                    :page-size="queryParams.pageSize"
                                    :total="total"
                                    @current-change="handleCurrentChange"
                                    background
                                    layout="total, prev, pager, next">
                            </el-pagination>
                        </div>

                    </div>
                </div>
            </div>
        </div>


    </div>
    <el-dialog :title="title" :visible.sync="open" width="50%">
        <el-form :model="form" :rules="rules" label-width="80px" ref="form">
            <el-form-item label="图片">
                <el-upload
                        :action="baseUrl+'/common/upload'"
                        :before-remove="beforeRemove"
                        :file-list="fileList"
                        :limit="3"
                        :on-exceed="handleExceed"
                        :on-preview="handlePreview"
                        :on-remove="handleRemove"
                        :on-success="handleFileSuccess"
                        class="upload-demo"
                        multiple>
                    <i class="el-icon-upload"></i>
                    <div class="el-upload__text">将图片拖到此处，或<em>点击上传</em></div>

                    <el-button size="small" type="primary">点击上传</el-button>

                </el-upload>
            </el-form-item>
            <el-form-item label="用户姓名" prop="username">
                <el-input v-model="form.username"></el-input>
            </el-form-item>
            <el-form-item label="性别">
                <el-input type="text" v-model="form.sex"></el-input>
            </el-form-item>
            <el-form-item label="联系方式">
                <el-input v-model="form.phonenumber"></el-input>
            </el-form-item>
            <el-form-item label="账号">
                <el-input v-model="form.account"></el-input>
            </el-form-item>
            <el-form-item label="密码">
                <el-input v-model="form.password"></el-input>
            </el-form-item>
            <el-form-item label="证件号">
                <el-input v-model="form.idcard"></el-input>
            </el-form-item>
            <el-form-item label="地址信息">
                <el-input v-model="form.address"></el-input>
            </el-form-item>
            <el-form-item label="年龄">
                <el-input v-model="form.age"></el-input>
            </el-form-item>
            <el-form-item label="备注信息">
                <el-input type="textarea" v-model="form.remark"></el-input>
            </el-form-item>

            <el-form-item>
                <el-button @click="submitEdit" type="primary">保存</el-button>
                <el-button @click="open = false">取消</el-button>
            </el-form-item>
        </el-form>
    </el-dialog>
    <el-dialog :visible.sync="openDetail" width="50%">
        <el-descriptions :column="4" :title="title" border>
            <el-descriptions-item :span="4" label="图片">
                <el-image :src="form.img"
                          style="width: 100px;height: 100px;"></el-image>
            </el-descriptions-item>
            <el-descriptions-item :span="2" label="用户姓名">{{form.username}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="性别">{{form.sex}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="联系方式">{{form.phonenumber}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="账号">{{form.account}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="密码">{{form.password}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="证件号">{{form.idcard}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="地址信息">{{form.address}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="年龄">{{form.age}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="创建时间">{{form.createtime}}</el-descriptions-item>
        </el-descriptions>
    </el-dialog>
</div>


<!-- 全局js -->
<script src="/static/hAdmin/js/jquery.min.js?v=2.1.4"></script>
<!--<script src="/static/hAdmin/js/bootstrap.min.js?v=3.3.6"></script>-->
<!-- Sweet alert -->
<script src="/static/hAdmin/js/plugins/sweetalert/sweetalert.min.js"></script>

<!-- 自定义js -->
<script src="/static/hAdmin/js/content.js?v=1.0.0"></script>


<script src="https://unpkg.com/element-ui/lib/index.js"></script>

<!--    分页js -->
<!--<script src="/static/wmmJs/public/PageHelper.js"></script>-->
<script src="/static/hAdmin/js/plugins/toastr/toastr.min.js"></script>
<script src="/static/js/GloJs.js"></script>
<script>

    new Vue({
        el: "#app",
        data() {
            return {
                baseUrl: gloRequestUrl,
                dataList: [],
                selectList: [],
                fileList: [],
                fileStr: [],
                total: 0,
                searchKey: "",
                loading: true,
                userId: localStorage.getItem("userId"),
                role: localStorage.getItem("role"),
                form: {},
                open: false,
                openDetail: false,
                queryParams: {
                    pageSize: 3,
                    pageNum: 1,
                },
                title: "",
                rules: {
                    title: [
                        {required: true, message: '请输入', trigger: 'blur'},

                    ],

                }
            }
        },
        methods: {
            handleResetQuery() {
                this.queryParams = {
                    pageSize: 3,
                    pageNum: 1,
                }
                this.getList()
            },
            removeElement(arr, elem) {
                return arr.filter(item => item !== elem);
            },
            handleRemove(file, fileList) {
                this.fileStr = this.removeElement(this.fileStr, file.response.msg)
            },
            handlePreview(file) {
                window.open(this.baseUrl + file.response.msg)
            },
            handleExceed(files, fileList) {
                this.$message.warning(`当前限制选择 3 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
            },
            beforeRemove(file, fileList) {
                return this.$confirm(`确定移除 ${file.name}？`);
            },
            handleFileSuccess(res) {
                let that = this
                that.fileStr.push(res.msg)
            },
            getSelectList() {
                let that = this;
                let param = {
                    "pageSize": 999,
                    "pageNum": that.queryParams.pageNum,

                }
                $.ajax({
                    url: that.baseUrl + "/tType/list",
                    type: "GET",
                    data: param,
                    success: function (data) {
                        if (data.code !== 500) {

                            that.selectList = data.list

                        }
                    },
                    error: function () {
                        windowsAuto(500, "服务器异常！network error！")
                    }
                });
            },
            // 获取列表
            getList() {
                let that = this;
                that.loading = true
                $.ajax({
                    url: that.baseUrl + "/sysuser",
                    type: "GET",
                    data: that.queryParams,
                    success: function (data) {
                        if (data.code !== 500) {
                            that.loading = false
                            that.dataList = data.list
                            that.total = data.total
                        }
                    },
                    error: function () {
                        windowsAuto(500, "服务器异常！network error！")
                    }
                });
            },
            submitEdit() {
                let that = this
                this.$refs['form'].validate((valid) => {
                    if (valid) {
                        if (that.fileStr && that.fileStr.length > 0) {
                            that.form.img = that.fileStr.join(",")

                        }
                        if (that.form.id == undefined) {
                            $.ajax({
                                url: that.baseUrl + "/sysuser",
                                type: "post",
                                data: JSON.stringify(that.form),
                                contentType: "application/json",
                                // headers: { 'Content-Type': 'application/json;charset=utf-8' },
                                success: function (data) {
                                    that.open = false
                                    if (data.code === 200) {
                                        toastr.success(data.msg, '提示')

                                    } else {

                                        toastr.error(data.msg, '提示')
                                    }
                                    that.getList()
                                },
                                error: function () {
                                    alert("服务器异常！network error！")
                                }
                            })
                        } else {

                            $.ajax({
                                url: that.baseUrl + "/sysuser",
                                type: "PUT",
                                data: JSON.stringify(that.form),
                                contentType: "application/json",
                                // headers: { 'Content-Type': 'application/json;charset=utf-8' },
                                success: function (data) {
                                    that.open = false
                                    if (data.code === 200) {
                                        toastr.success(data.msg, '提示')

                                    } else {

                                        toastr.error(data.msg, '提示')
                                    }
                                    that.getList()
                                },
                                error: function () {
                                    alert("服务器异常！network error！")
                                }
                            })
                        }

                    }
                })
            },
            reset() {
                this.form = {}
                this.fileStr = []
                this.fileList = []
            },
            //打开详情
            handleDetail(row) {
                let that = this;
                that.form = row
                that.title = "详情"
                that.openDetail = true

            },
            handleDel(id) {
                let that = this;
                swal({
                    title: "您确定要删除该信息吗",
                    text: "删除后不可恢复！",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "删除",
                    cancelButtonText: "我再想想",
                    closeOnConfirm: false
                }, function () {
                    $.ajax({
                        url: that.baseUrl + "/sysuser",
                        type: "DELETE",
                        data: {
                            id: id,
                        },
                        success: function (data) {
                            windowsAuto(data.code, data.msg)
                            that.getList()
                        },
                        error: function () {
                            alert("服务器异常！network error！")
                        }
                    })

                });
            },
            handleEdit(row) {
                let that = this
                that.form = row
                that.open = true
                that.title = "编辑"
            },
            handleAdd() {
                let that = this
                that.reset()
                that.open = true
                that.title = "新增"
            },

            handleCurrentChange() {
                let that = this;
                that.getList()
            },


        },
        watch: {},
        mounted() {
            let that = this;
            if (that.queryParams) {
                that.getList()
                that.getSelectList()
            }


        }
    })

</script>
</body>
</html>
