<!DOCTYPE html>
<html lang="en">
  <head>
    <title>购物车界面</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <script src="/static/DemoBootStrap/js/vue.js"></script>
    <link rel="stylesheet" href="/static/webSite/css/swiper-bundle.min.css">

    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0-alpha3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/static/webSite/css/vendor.css">
    <link rel="stylesheet" type="text/css" href="/static/webSite/style.css">
    <link href="/static/hAdmin/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <link href="/static/hAdmin/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="/static/hAdmin/css/plugins/toastr/toastr.min.css" rel="stylesheet">
    <link href="/static/element/element.css" rel="stylesheet">

  </head>
<body>
<div id="app">


<div class="preloader-wrapper">
  <div class="preloader">
  </div>
</div>
<header>

  <div class="container-fluid">
    <div class="row py-3 border-bottom">

      <div class="col-sm-4 col-lg-2 text-center text-sm-start d-flex gap-3 justify-content-center justify-content-md-start">
        <div class="d-flex align-items-center my-3 my-sm-0">
          <a href="/web/userindex">
            <img v-if="userInfo && userInfo.img" :src="userInfo.img" alt="用户头像" class="img-fluid"
                 style="width: 50px;height: 50px; border-radius: 50%; border: 2px solid #007bff;">
            <img v-else src="/static/webSite/images/logo.png" style="width: 50px;height: 50px;" alt="logo" class="img-fluid">
          </a>
        </div>
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
                aria-controls="offcanvasNavbar">
          <svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#menu"></use></svg>
        </button>
      </div>

      <div class="col-md-2 ">
        <div class="search-bar row bg-light p-2 rounded-4">

          <div class="col-11 col-md-10" style="text-align: center">
            宠物服务订购平台
          </div>

        </div>
      </div>

      <div class="col-md-8">
        <ul class="navbar-nav list-unstyled d-flex flex-row gap-3 gap-lg-5 justify-content-center flex-wrap align-items-center mb-0 fw-bold text-uppercase text-dark">
          <li class="nav-item ">
            <a href="/web/userindex" class="nav-link">主页</a>
          </li>

          <li class="nav-item">
            <a href="/web/userproductlist"  class="nav-link  ">宠物服务列表</a>
          </li>
          <li class="nav-item text-primary">
            <a href="/web/usercart"  class="nav-link ">购物车</a>
          </li>
          <li class="nav-item">
            <a href="/web/usercontact"  class="nav-link ">联系我们</a>
          </li>
          <li class="nav-item">
            <a href="/web/userblog"  class="nav-link ">网站资讯/公告</a>
          </li>
          <li class="nav-item">
            <a href="/web/personal" class="nav-link d-flex align-items-center" title="个人中心">
              <img v-if="userInfo && userInfo.img" :src="userInfo.img" alt="用户头像"
                   style="width: 30px; height: 30px; border-radius: 50%; margin-right: 5px; border: 2px solid #007bff;">
              <i v-else class="fa fa-user"></i>
              <span v-if="userInfo && userInfo.username" style="margin-left: 5px;">{{userInfo.username}}</span>
            </a>
          </li>
        </ul>
      </div>



    </div>
  </div>
</header>

  <section class="jarallax py-5">
    <img src="/static/webSite/images/banner-1.jpg" class="jarallax-img">
    <div class="hero-content py-0 py-md-5">
        <div class="container-lg d-flex flex-column d-md-block align-items-center">
        <nav class="breadcrumb">
          <a class="breadcrumb-item nav-link" href="/static/webindex">主页</a>
          <span  class="breadcrumb-item active" aria-current="page">购物车</span>
        </nav>
        <h1 style="color: whitesmoke">购物车</h1>
      </div>
    </div>
  </section>

  <section class="py-5">
    <div class="container-lg">
      <div class="row g-5">
        <div class="col-md-8">

          <div class="table-responsive cart">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col" class="card-title text-uppercase text-muted">
                    <input type="checkbox" @change="selectAll" v-model="allSelected"> 全选
                  </th>
                  <th scope="col" class="card-title text-uppercase text-muted">宠物服务图</th>
                  <th scope="col" class="card-title text-uppercase text-muted">数量</th>
                  <th scope="col" class="card-title text-uppercase text-muted">单价</th>
                  <th scope="col" class="card-title text-uppercase text-muted">操作</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="item in dataList">
                  <td class="py-4 text-center">
                    <input type="checkbox" v-model="item.selected" @change="updateSelection">
                  </td>
                  <td scope="row" class="py-4">
                    <div class="cart-info d-flex flex-wrap align-items-center mb-4">
                      <div class="col-lg-3">
                        <div class="card-image">
                          <img style="width: 80px;height: 80px;" :src="item.product.img" alt="product name" class="img-fluid">
                        </div>
                      </div>
                      <div class="col-lg-9">
                        <div class="card-detail ps-3">
                          <h5 class="card-title">
                            <a :href="'/web/usersingle?id='+item.productid" class="text-decoration-none">{{item.product.productname}}</a>
                          </h5>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="py-4">
                    <div class="input-group product-qty w-50">
                      <span class="input-group-btn">
                        <button type="button" class="quantity-left-minus btn btn-light btn-number" data-type="minus" @click="handleMinusNumber(item.number,item.id)">
                          <i class="fa fa-minus"></i>
                        </button>
                      </span>
                      <input type="text" id="quantity" name="quantity" class="form-control input-number text-center"
                             :value="item.number"
                        >
                      <span class="input-group-btn">
                        <button type="button" class="quantity-right-plus btn btn-light btn-number" data-type="plus" @click="handleAddNumber(item.number,item.id)"
                          data-field="">
                         <i class="fa fa-plus"></i>
                        </button>
                      </span>
                    </div>
                  </td>
                  <td class="py-4">
                    <div class="total-price">
                      <span>￥{{item.product.kedanjia}}</span>
<!--                      <span class="text-dark fw-semibold">{{parseFloat(item.product.kedanjia) * parseFloat(item.product.spare2) / 10-->
<!--                        }}</span>-->
                    </div>
                  </td>
                  <td class="py-4">
                    <div class="cart-remove">
                      <button class="btn btn-warning" @click="handleDel(item.id)" >
                       <i class="fa fa-trash"></i> 删除
                      </button>
                    </div>
                  </td>
                </tr>

              </tbody>
            </table>
          </div>

        </div>
        <div class="col-md-4">
          <div class="cart-totals bg-grey py-5">
            <h4 class="text-dark pb-4">总价</h4>
            <div class="total-price pb-5">
              <table cellspacing="0" class="table text-uppercase">
                <tbody>
                  <tr class="subtotal pt-2 pb-2 border-top border-bottom">
                    <th>总价</th>
                    <td data-title="Subtotal">
                      <span class="price-amount amount text-dark ps-5">
                        <bdi>
                          <span class="price-currency-symbol">￥{{sum}}</span>
                        </bdi>
                      </span>
                    </td>
                  </tr>
<!--                  <tr class="order-total pt-2 pb-2 border-bottom">-->
<!--                    <th>折后价</th>-->
<!--                    <td data-title="Total">-->
<!--                      <span class="price-amount amount text-dark ps-5">-->
<!--                        <bdi>-->
<!--                          <span class="price-currency-symbol">￥</span>{{sumAfter}}</bdi>-->
<!--                      </span>-->
<!--                    </td>-->
<!--                  </tr>-->
                </tbody>
              </table>
            </div>
            <div class="cart-summary mb-3">
              <div class="row">
                <div class="col-md-6">
                  <h5>已选择商品：{{selectedCount}} 件</h5>
                  <h5>总价：￥{{selectedTotal}}</h5>
                </div>
                <div class="col-md-6 text-end">
                  <h5>优惠后总价：￥{{selectedDiscountTotal}}</h5>
                </div>
              </div>
            </div>
            <div class="button-wrap row g-2">

              <div class="col-md-6">
                <button
                        v-if="selectedItems.length > 0"
                  class="btn btn-primary py-3 px-4 text-uppercase btn-rounded-none w-100"
                  @click="erweima">购买选中商品 ({{selectedCount}}件)</button>
                <button
                        v-else
                  class="btn btn-secondary py-3 px-4 text-uppercase btn-rounded-none w-100"
                  disabled>请选择要购买的商品</button>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
  <el-dialog :visible.sync="qrcodeopen" title="请支付">
    <div style="text-align: center">
      <h3 style="margin: 0 auto">您可以使用以下支付方式进行支付：</h3>

    </div>
    <div style="text-align: center">
      <img src="../static/img/pay.jpg" style="width: 200px;height: 100px;">

    </div>
    <div style="text-align: center">
      <img src="../static/img/zfb.jpg" alt="" style="width: 200px;height: 200px;">

      <img src="../static/img/wxzf.jpg" alt="" style="width: 200px;height: 200px;">
    </div>

    <div style="text-align: center;margin-top: 20px">
      <el-button type="primary" @click="handleOrder">提交订单</el-button>

    </div>
  </el-dialog>

<section class="pb-4 my-4">
  <div class="container-lg" >

    <div class="bg-warning pt-5 rounded-5" >
      <div class="container" style="background-image: url('/static/webSite/images/bottomBanner.jpg')">
        <div class="row justify-content-center align-items-center">
          <div class="col-md-4">
            <h2 class="mt-5">加入购物车进行购买</h2>
            <p>如果遇到问题，请联系我们留言</p>
            <div class="d-flex gap-2 flex-wrap mb-5">
              <a class="btn btn-danger" href="/web/usercart" title="前往购物车">前往购物车 <i class="fa fa-shopping-cart"></i></a>
              <a class="btn btn-primary" href="/web/personal?activeName=third" title="前往订单">前往订单 <i class="fa fa-list"></i></a>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</section>
<section class="py-5">
  <div class="container-lg">
    <div class="row row-cols-1 row-cols-sm-3 row-cols-lg-5">
      <div class="col">
        <div class="card mb-3 border border-dark-subtle p-3">
          <div class="text-dark mb-3">
            <i class="fa fa-battery-4"></i>
          </div>
          <div class="card-body p-0">
            <h5>宠物服务保证</h5>
            <p class="card-text">渠道正规，审核合格.</p>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card mb-3 border border-dark-subtle p-3">
          <div class="text-dark mb-3">
            <i class="fa fa-bell"></i>              </div>
          <div class="card-body p-0">
            <h5>100% 真实</h5>
            <p class="card-text">活动与折扣真实有效.</p>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card mb-3 border border-dark-subtle p-3">
          <div class="text-dark mb-3">
            <i class="fa fa-shopping-cart"></i>
          </div>
          <div class="card-body p-0">
            <h5>购物车一件选购</h5>
            <p class="card-text">灵活自如，快捷下单.</p>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card mb-3 border border-dark-subtle p-3">
          <div class="text-dark mb-3">
            <i class="fa fa-bar-chart"></i>
          </div>
          <div class="card-body p-0">
            <h5>遇到问题请留言</h5>
            <p class="card-text">后台全天回复.</p>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card mb-3 border border-dark-subtle p-3">
          <div class="text-dark mb-3">
            <i class="fa fa-user"></i>
          </div>
          <div class="card-body p-0">
            <h5>个性展示</h5>
            <p class="card-text">更改个人信息，彰显个性.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="footer-bottom">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-6 copyright">
        <p>@  2024 - 宠物服务订购平台.</p>
      </div>

    </div>
  </div>
</div>
</div>
  <script src="/static/webSite/js/jquery-1.11.0.min.js"></script>
  <script src="/static/webSite/js/plugins.js"></script>
<script src="/static/hAdmin/js/plugins/sweetalert/sweetalert.min.js"></script>
<script src="/static/webSite/js/swiper-bundle.js"></script>
<script src="/static/element/element.js"></script>
  <script src="/static/webSite/js/script.js"></script>
<script src="/static/hAdmin/js/plugins/toastr/toastr.min.js"></script>

<script src="/static/js/GloJs.js"></script>
<script>

  new Vue({
    el: "#app",
    data() {
      return {
        baseUrl: gloRequestUrl,
        dataList: [],
        producttypeList: [],
        userInfo: {},
        fileList: [],
        fileStr: [],
        total: 0,
        sum: 0,
        sumAfter: 0,
        searchKey: "",
        loading: true,
        userId: localStorage.getItem("userId"),
        role: localStorage.getItem("role"),
        allSelected: false,
        form: {},
        open: false,
        openDetail: false,
        qrcodeopen: false,
        queryParams: {
          pageSize: 100,
          pageNum: 1,
          spare1: 0,
          userid: localStorage.getItem("userId"),
        },
        title: "",
        rules: {
          title: [
            {required: true, message: '请输入', trigger: 'blur'},

          ],

        }
      }
    },
    computed: {
      selectedItems() {
        return this.dataList.filter(item => item.selected);
      },
      selectedCount() {
        return this.selectedItems.length;
      },
      selectedTotal() {
        return this.selectedItems.reduce((total, item) => {
          return total + (parseFloat(item.product.kedanjia || 0) * parseInt(item.number || 0));
        }, 0).toFixed(2);
      },
      selectedDiscountTotal() {
        return this.selectedItems.reduce((total, item) => {
          const price = parseFloat(item.product.kedanjia || 0);
          let discount = 10; // 默认无折扣
          if (item.product.spare2 && !isNaN(parseFloat(item.product.spare2))) {
            const discountValue = parseFloat(item.product.spare2);
            if (discountValue > 0 && discountValue < 10) {
              discount = discountValue;
            }
          }
          const quantity = parseInt(item.number || 0);
          return total + (price * discount / 10 * quantity);
        }, 0).toFixed(2);
      }
    },
    methods: {
      // 全选/取消全选
      selectAll() {
        this.dataList.forEach(item => {
          item.selected = this.allSelected;
        });
      },
      // 更新选择状态
      updateSelection() {
        this.allSelected = this.dataList.length > 0 && this.dataList.every(item => item.selected);
      },

      getproductTypeList() {
        let that = this;
        let param = {
          "pageSize": 999,
          "pageNum": that.queryParams.pageNum,

        }
        $.ajax({
          url: that.baseUrl + "/producttype",
          type: "GET",
          data: param,
          success: function (data) {
            if (data.code !== 500) {

              that.producttypeList = data.list

            }
          },
          error: function () {
            windowsAuto(500, "服务器异常！network error！")
          }
        });
      },
      // 获取列表
      getList() {
        let that = this;
        that.loading = true
        $.ajax({
          url: that.baseUrl + "/shopcart",
          type: "GET",
          data: that.queryParams,
          success: function (data) {
            if (data.code !== 500) {
              that.loading = false
              that.dataList = data.list
              // 为每个商品添加选中状态
              that.dataList && that.dataList.forEach((el, index)=>{
                that.$set(el, 'selected', false); // 使用Vue.set确保响应式
              })
              let sum = 0
              let sumAfter = 0
              that.dataList && that.dataList.forEach((el)=>{
                sum = sum + (el.product.kedanjia * el.number)
                let discount = 10; // 默认无折扣
                if (el.product.spare2 && !isNaN(parseFloat(el.product.spare2))) {
                  const discountValue = parseFloat(el.product.spare2);
                  if (discountValue > 0 && discountValue < 10) {
                    discount = discountValue;
                  }
                }
                sumAfter = sumAfter + (el.product.kedanjia * discount / 10 * el.number)
              })
              that.total = data.total
              that.sumAfter = sumAfter
              that.sum = sum
            }
          },
          error: function () {
            windowsAuto(500, "服务器异常！network error！")
          }
        });
      },

      handleDel(id) {
        let that = this;
        swal({
          title: "您确定要删除该购物车数据吗",
          text: "删除后不可恢复！",
          type: "warning",
          showCancelButton: true,
          confirmButtonColor: "#DD6B55",
          confirmButtonText: "删除",
          cancelButtonText: "我再想想",
          closeOnConfirm: false
        }, function () {
          $.ajax({
            url: that.baseUrl + "/shopcart",
            type: "DELETE",
            data: {
              id: id,
            },
            success: function (data) {
              windowsAuto(data.code, data.msg)
              that.getList()
            },
            error: function () {
              alert("服务器异常！network error！")
            }
          })

        });
      },

      handleAddNumber(number,id){
        let that = this
        console.log(number)
        console.log(id)
        let param = {
          number:number + 1,

          id:id,
        }
        $.ajax({
          url: that.baseUrl + "/shopcart",
          type: "put",
          data: JSON.stringify(param),
          contentType: "application/json",
          // headers: { 'Content-Type': 'application/json;charset=utf-8' },
          success: function (data) {
            that.open = false
            if (data.code === 200) {
              toastr.success(data.msg, '提示')

            } else {

              toastr.error(data.msg, '提示')
            }
            that.getList()
          },
          error: function () {
            alert("服务器异常！network error！")
          }
        })
      },
      handleMinusNumber(number,id){
        let that = this
  if (number == 1){
    windowsAuto(500,"购物车数量最少为1！")
    return false
  }
        let param = {
          number:number - 1,
          id:id,
        }
        $.ajax({
          url: that.baseUrl + "/shopcart",
          type: "put",
          data: JSON.stringify(param),
          contentType: "application/json",
          // headers: { 'Content-Type': 'application/json;charset=utf-8' },
          success: function (data) {
            that.open = false
            if (data.code === 200) {
              toastr.success(data.msg, '提示')

            } else {

              toastr.error(data.msg, '提示')
            }
            that.getList()
          },
          error: function () {
            alert("服务器异常！network error！")
          }
        })
      },
      erweima(){
        if (this.selectedItems.length === 0) {
          toastr.error("请选择要购买的商品", '提示')
          return false
        }
        this.qrcodeopen = true
      },
      handleOrder(){
        let that = this
        this.qrcodeopen = false
        // 获取选中商品的ID
        let selectedCartIds = this.selectedItems.map(item => item.id).join(',')
        let param = {
          userid: that.userId,
          selectedCartIds: selectedCartIds
        }
        $.ajax({
          url: that.baseUrl + "/order",
          type: "post",
          data: JSON.stringify(param),
          contentType: "application/json",
          // headers: { 'Content-Type': 'application/json;charset=utf-8' },
          success:function (data) {
            if (data.code === 200) {
              toastr.success(data.msg, '提示')
            } else {
              toastr.error(data.msg, '提示')
            }
            that.getList()
          },
          error: function () {
            alert("服务器异常！network error！")
          }
        })
      },
      // 获取用户信息
      getUserInfo(){
        let that = this
        if (that.userId) {
          $.ajax({
            url: that.baseUrl + "/sysuser/detail",
            type: "GET",
            data: {id: that.userId},
            success: function (data) {
              if (data.code !== 500) {
                that.userInfo = data.Data
              }
            },
            error: function () {
              console.log("获取用户信息失败")
            }
          });
        }
      }
    },
    watch: {},
    mounted() {
      let that = this;
      that.getList()
      that.getUserInfo()
    }
  })

</script>
</body>
</html>
