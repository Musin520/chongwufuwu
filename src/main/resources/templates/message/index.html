<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">


    <title> 消息</title>
    <meta content="" name="keywords">
    <meta content="" name="description">

    <link href="favicon.ico" rel="shortcut icon">
    <script src="/static/DemoBootStrap/js/vue.js"></script>
    <!--    <link href="/static/hAdmin/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">-->
    <link href="/static/hAdmin/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <!-- Sweet Alert -->
    <link href="/static/hAdmin/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="/static/hAdmin/css/animate.css" rel="stylesheet">
    <link href="/static/hAdmin/css/style.css?v=4.1.0" rel="stylesheet">
    <link href="/static/hAdmin/css/plugins/toastr/toastr.min.css" rel="stylesheet">
    <link href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" rel="stylesheet">
    <style>
        .addList {
            padding: 10px 30px 10px 30px;
            height: 90px;
            margin-top: 3px
        }
    </style>

</head>

<body class="gray-bg animated bounceInDown">
<div id="app">
    <div id="block"
         style="width: 100%;height: 100%;background: #171717;opacity: 0.7;position: fixed;top: 0;left: 0;z-index: 999;text-align: center;display: none">
        <div style="margin-top: 300px">
            <span style="color: #ffffff;font-size: 20px;font-weight: 700">正在提交本次操作，请勿进行任何操作......</span>
        </div>
    </div>
    <div class="wrapper wrapper-content animated fadeInUp">
        <span id="gloUrl" style="display: none"></span>

        <div class="row">
            <div class="col-sm-12">

                <div class="ibox">
                    <div class="ibox-title" style="height: 55px;">
                        <h5>所有记录</h5>
                        <div class="ibox-tools">
                            <div class="text-center">
                                <el-button
                                        @click="handleAdd"
                                        v-if="role === '1'"
                                        type="primary">
                                    发送消息
                                </el-button>
                                <el-button
                                        @click="handleAdd"
                                        v-if="role === '3'"
                                        type="primary">
                                    发送消息
                                </el-button>
                            </div>

                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="row m-b-sm m-t-sm">

                            <div class="col-md-11 form-inline">
                                <el-form :inline="true" :model="queryParams" class="demo-form-inline">
                                    <el-form-item label="消息">
                                        <el-input placeholder="消息" v-model="queryParams.content"></el-input>
                                    </el-form-item>
                                    <el-form-item label="类型">
                                        <el-select placeholder="类型" v-model="queryParams.status">
                                            <el-option label="已回复" :value="1"></el-option>
                                            <el-option label="未回复" :value="0"></el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button @click="getList" type="primary"><i class="fa fa-search"></i> 查询
                                        </el-button>
                                        <el-button @click="handleResetQuery" type="info"><i class="fa fa-circle"></i> 重置
                                        </el-button>
                                    </el-form-item>
                                </el-form>
                            </div>
                        </div>
                        <!--            列表          -->
                        <div class="project-list">
                            <div class="ibox-content">
                                <el-table
                                        height="550"
                                        :data="dataList"
                                        style="width: 100%"
                                        v-loading="loading">
                                    <el-table-column
                                            align="center"
                                            label="id"
                                            prop="id"
                                    >
                                    </el-table-column>

                                    <el-table-column
                                            align="center"
                                            label="消息"
                                            prop="content"
                                    >
                                    </el-table-column>

                                    <el-table-column
                                            align="center"
                                            label="发送人"
                                            prop="senderName">
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="状态"
                                            prop="status">
                                        <template slot-scope="scope">
                                           <el-tag type="info" v-if="scope.row.status == '1'">已回复</el-tag>
                                           <el-tag type="danger" v-if="scope.row.status == '0'">未回复</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="发送时间"
                                            prop="createtime">
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="更新时间"
                                            prop="updatetime">
                                    </el-table-column>
                                    <el-table-column
                                            align="center"
                                            label="操作"
                                            width="350px"
                                    >
                                        <template slot-scope="scope">
                                            <!-- 管理员可以回复和删除所有消息 -->
                                            <el-button @click="handleEdit(scope.row)" round size="small" type="warning"
                                                       v-if="role === '1'">
                                                <i class="fa fa-pencil"></i> 回复
                                            </el-button>
                                            <el-button @click="handleDel(scope.row.id)" round size="small"
                                                       v-if="role === '1'"
                                                       type="danger"><i class="fa fa-trash"></i> 删除
                                            </el-button>

                                            <!-- 服务商可以回复发给自己的消息 -->
                                            <el-button @click="handleEdit(scope.row)" round size="small" type="warning"
                                                       v-if="role === '3' && scope.row.receiveid == userId">
                                                <i class="fa fa-pencil"></i> 回复
                                            </el-button>

                                            <!-- 用户可以查看聊天记录 -->
                                            <el-button @click="handleChat(scope.row)" round size="small" type="primary"
                                                       v-if="role === '2'">
                                                <i class="fa fa-comments"></i> 聊天
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                        <div style="width: 100%;text-align: center">
                            <el-pagination
                                    :current-page.sync="queryParams.pageNum"
                                    :page-size="queryParams.pageSize"
                                    :total="total"
                                    @current-change="handleCurrentChange"
                                    background
                                    layout="total, prev, pager, next">
                            </el-pagination>
                        </div>

                    </div>
                </div>
            </div>
        </div>


    </div>
    <el-dialog :title="title" :visible.sync="open" width="50%">
        <el-form :model="form" :rules="rules" label-width="160px" ref="form">


            <el-form-item label="消息" prop="content">
                <el-input type="textarea" disabled="" v-model="form.content"></el-input>
            </el-form-item>
            <el-form-item label="请输入你要回复的内容" prop="rescontent">
                <el-input type="textarea"  v-model="form.rescontent"></el-input>
            </el-form-item>
            <el-form-item>
                <el-button @click="submitEdit" type="primary">发送</el-button>
                <el-button @click="open = false">取消</el-button>
            </el-form-item>
        </el-form>
    </el-dialog>
    <el-dialog :visible.sync="openDetail" width="50%">
        <el-descriptions :column="4" :title="title" border>
            <el-descriptions-item :span="4" label="图片">
                <el-image :src="form.img"
                          style="width: 100px;height: 100px;"></el-image>
            </el-descriptions-item>
            <el-descriptions-item :span="2" label="消息名称">{{form.content}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="营业执照统一信贷码">{{form.yingyezhizhaohao}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="联系方式">{{form.phonenumber}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="法人">{{form.senderid}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="注册地址">{{form.address}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="注册时间">{{form.zhuceshijian}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="创建时间">{{form.createtime}}</el-descriptions-item>
            <el-descriptions-item :span="2" label="创建时间">{{form.createtime}}</el-descriptions-item>
            <el-descriptions-item :span="4" label="经营范围">{{form.jingyingfanwei}}</el-descriptions-item>
        </el-descriptions>
    </el-dialog>

    <!-- 聊天对话框 -->
    <el-dialog title="聊天对话" :visible.sync="chatVisible" width="60%" :before-close="handleChatClose">
        <div class="chat-container" style="height: 500px; display: flex; flex-direction: column;">
            <!-- 聊天头部信息 -->
            <div class="chat-header" style="padding: 10px; border-bottom: 1px solid #ebeef5; background: #f5f7fa;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fa fa-user-circle" style="font-size: 24px; color: #409eff;"></i>
                    <div>
                        <div style="font-weight: bold;">{{chatPartner.name}}</div>
                        <div style="font-size: 12px; color: #909399;">
                            {{chatPartner.role == '3' ? '服务商' : (chatPartner.role == '1' ? '管理员' : '用户')}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 聊天消息区域 -->
            <div class="chat-messages" ref="chatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa;">
                <div v-for="message in chatMessages" :key="message.id" class="message-item" style="margin-bottom: 15px;">
                    <div :class="['message-bubble', message.senderid == userId ? 'sent' : 'received']"
                         :style="message.senderid == userId ? 'text-align: right;' : 'text-align: left;'">
                        <div class="message-info" style="font-size: 12px; color: #909399; margin-bottom: 5px;">
                            <span>{{message.senderid == userId ? '我' : message.senderName}}</span>
                            <span style="margin-left: 10px;">{{message.createtime}}</span>
                        </div>
                        <div class="message-content"
                             :style="message.senderid == userId ?
                             'background: #409eff; color: white; padding: 8px 12px; border-radius: 18px; display: inline-block; max-width: 70%; margin-left: auto;' :
                             'background: white; color: #333; padding: 8px 12px; border-radius: 18px; display: inline-block; max-width: 70%; border: 1px solid #e4e7ed;'">
                            {{message.content}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 消息输入区域 -->
            <div class="chat-input" style="padding: 15px; border-top: 1px solid #ebeef5; background: white;">
                <div style="display: flex; gap: 10px;">
                    <el-input
                        v-model="newMessage"
                        placeholder="输入消息..."
                        @keyup.enter.native="sendMessage"
                        style="flex: 1;">
                    </el-input>
                    <el-button type="primary" @click="sendMessage" :disabled="!newMessage.trim()">
                        <i class="fa fa-send"></i> 发送
                    </el-button>
                </div>
            </div>
        </div>
    </el-dialog>
</div>


<!-- 全局js -->
<script src="/static/hAdmin/js/jquery.min.js?v=2.1.4"></script>
<!--<script src="/static/hAdmin/js/bootstrap.min.js?v=3.3.6"></script>-->
<!-- Sweet alert -->
<script src="/static/hAdmin/js/plugins/sweetalert/sweetalert.min.js"></script>

<!-- 自定义js -->
<script src="/static/hAdmin/js/content.js?v=1.0.0"></script>


<script src="https://unpkg.com/element-ui/lib/index.js"></script>

<!--    分页js -->
<!--<script src="/static/wmmJs/public/PageHelper.js"></script>-->
<script src="/static/hAdmin/js/plugins/toastr/toastr.min.js"></script>
<script src="/static/js/GloJs.js"></script>
<script>

    new Vue({
        el: "#app",
        data() {
            return {
                baseUrl: gloRequestUrl,
                dataList: [],
                selectList: [],
                fileList: [],
                fileStr: [],
                total: 0,
                searchKey: "",
                loading: true,
                userId: localStorage.getItem("userId"),
                role: localStorage.getItem("role"),
                form: {},
                open: false,
                openDetail: false,
                queryParams: {
                    pageSize: 6,
                    pageNum: 1,
                    receiveid: localStorage.getItem("userId"),
                },
                title: "",
                rules: {
                    title: [
                        {required: true, message: '请输入', trigger: 'blur'},

                    ],

                },
                // 聊天相关数据
                chatVisible: false,
                chatPartner: {},
                chatMessages: [],
                newMessage: ''
            }
        },
        methods: {
            handleResetQuery() {
                this.queryParams = {
                    pageSize: 6,
                    pageNum: 1,
                }
                this.getList()
            },
            removeElement(arr, elem) {
                return arr.filter(item => item !== elem);
            },
            handleRemove(file, fileList) {
                this.fileStr = this.removeElement(this.fileStr, file.response.msg)
            },
            handlePreview(file) {
                window.open(this.baseUrl + file.response.msg)
            },
            handleExceed(files, fileList) {
                this.$message.warning(`当前限制选择 3 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
            },
            beforeRemove(file, fileList) {
                return this.$confirm(`确定移除 ${file.name}？`);
            },
            handleFileSuccess(res) {
                let that = this
                that.fileStr.push(res.msg)
            },
            getSelectList() {
                let that = this;
                let param = {
                    "pageSize": 999,
                    "pageNum": that.queryParams.pageNum,

                }
                $.ajax({
                    url: that.baseUrl + "/tType/list",
                    type: "GET",
                    data: param,
                    success: function (data) {
                        if (data.code !== 500) {

                            that.selectList = data.list

                        }
                    },
                    error: function () {
                        windowsAuto(500, "服务器异常！network error！")
                    }
                });
            },
            // 获取列表
            getList() {
                let that = this;
                that.loading = true
                $.ajax({
                    url: that.baseUrl + "/message",
                    type: "GET",
                    data: that.queryParams,
                    success: function (data) {
                        if (data.code !== 500) {
                            that.loading = false
                            that.dataList = data.list
                            that.total = data.total
                        }
                    },
                    error: function () {
                        windowsAuto(500, "服务器异常！network error！")
                    }
                });
            },
            submitEdit() {
                let that = this
                this.$refs['form'].validate((valid) => {
                    if (valid) {
                        if (that.fileStr && that.fileStr.length > 0) {
                            that.form.img = that.fileStr.join(",")

                        }

                        let updateParam = {
                          id:  that.form.id,
                          status:  "1"
                        }
                        let newParam ={
                            senderid : that.userId,
                            receiveid : that.form.senderid,
                            content : that.form.rescontent,
                            status : "0",
                        }


                            $.ajax({
                                url: that.baseUrl + "/message",
                                type: "post",
                                data: JSON.stringify(newParam),
                                contentType: "application/json",
                                // headers: { 'Content-Type': 'application/json;charset=utf-8' },
                                success: function (data) {
                                    $.ajax({
                                        url: that.baseUrl + "/message",
                                        type: "PUT",
                                        data: JSON.stringify(updateParam),
                                        contentType: "application/json",
                                        // headers: { 'Content-Type': 'application/json;charset=utf-8' },
                                        success: function (data) {
                                            that.open = false
                                            if (data.code === 200) {
                                                toastr.success(data.msg, '提示')
                                            } else {
                                                toastr.error(data.msg, '提示')
                                            }
                                            that.getList()
                                        },
                                        error: function () {
                                            alert("服务器异常！network error！")
                                        }
                                    })

                                },
                                error: function () {
                                    alert("服务器异常！network error！")
                                }
                            })






                    }
                })
            },
            reset() {
                this.form = {}
                this.fileStr = []
                this.fileList = []
            },
            //打开详情
            handleDetail(row) {
                let that = this;
                that.form = row
                that.title = "详情"
                that.openDetail = true

            },
            handleDel(id) {
                let that = this;
                swal({
                    title: "您确定要删除该信息吗",
                    text: "删除后不可恢复！",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "删除",
                    cancelButtonText: "我再想想",
                    closeOnConfirm: false
                }, function () {
                    $.ajax({
                        url: that.baseUrl + "/message",
                        type: "DELETE",
                        data: {
                            id: id,
                        },
                        success: function (data) {
                            windowsAuto(data.code, data.msg)
                            that.getList()
                        },
                        error: function () {
                            alert("服务器异常！network error！")
                        }
                    })

                });
            },
            handleEdit(row) {
                let that = this
                that.form = row
                that.open = true
                that.title = "编辑"
            },
            handleAdd() {
                let that = this
                that.reset()
                that.open = true
                that.title = "新增"
            },

            handleCurrentChange() {
                let that = this;
                that.getList()
            },

            // 处理聊天功能
            handleChat(row) {
                let that = this;
                // 确定聊天对象
                let partnerId = row.senderid === parseInt(that.userId) ? row.receiveid : row.senderid;
                let partnerName = row.senderid === parseInt(that.userId) ? row.receiverName : row.senderName;
                let partnerRole = row.senderid === parseInt(that.userId) ? row.receiverRole : row.senderRole;

                // 设置聊天对象信息
                that.chatPartner = {
                    id: partnerId,
                    name: partnerName,
                    role: partnerRole
                };

                // 打开聊天对话框
                that.chatVisible = true;
                that.loadChatMessages();
            },

            // 加载聊天记录
            loadChatMessages() {
                let that = this;
                $.ajax({
                    url: that.baseUrl + "/message/chat",
                    type: "GET",
                    data: {
                        userId: that.userId,
                        partnerId: that.chatPartner.id
                    },
                    success: function (data) {
                        if (data.code === 200) {
                            that.chatMessages = data.list || [];
                            that.$nextTick(() => {
                                that.scrollToBottom();
                            });
                        }
                    },
                    error: function () {
                        that.$message.error("加载聊天记录失败");
                    }
                });
            },

            // 发送消息
            sendMessage() {
                let that = this;
                if (!that.newMessage.trim()) {
                    return;
                }

                $.ajax({
                    url: that.baseUrl + "/message/form",
                    type: "POST",
                    data: {
                        content: that.newMessage,
                        senderid: that.userId,
                        receiveid: that.chatPartner.id,
                        status: "0"
                    },
                    success: function (data) {
                        if (data.code === 200) {
                            that.newMessage = '';
                            that.loadChatMessages(); // 重新加载消息
                            that.$message.success("消息发送成功");
                        } else {
                            that.$message.error(data.msg || "发送失败");
                        }
                    },
                    error: function () {
                        that.$message.error("发送消息失败");
                    }
                });
            },

            // 关闭聊天对话框
            handleChatClose() {
                this.chatVisible = false;
                this.chatMessages = [];
                this.newMessage = '';
            },

            // 滚动到底部
            scrollToBottom() {
                if (this.$refs.chatMessages) {
                    this.$refs.chatMessages.scrollTop = this.$refs.chatMessages.scrollHeight;
                }
            },


        },
        watch: {},
        mounted() {
            let that = this;
            if (that.queryParams) {
                that.getList()
                // that.getSelectList()
            }


        }
    })

</script>
</body>
</html>
